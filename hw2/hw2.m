clear;

% Data for the magnitude response
VinVout = [0.0178   10.0000
    0.0182   10.2300
    0.0186   10.4700
    0.0191   10.7200
    0.0195   10.9600
    0.0200   11.2200
    0.0204   11.6100
    0.0209   11.8900
    0.0214   12.1600
    0.0219   12.5900
    0.0224   12.8800
    0.0229   13.1800
    0.0234   13.6500
    0.0240   13.9600
    0.0245   14.2900
    0.0251   14.6200
    0.0257   15.1400
    0.0263   15.4900
    0.0269   15.8500
    0.0275   16.4100
    0.0282   16.7900
    0.0288   17.3800
    0.0295   17.7800
    0.0302   18.4100
    0.0309   18.8400
    0.0316   19.5000
    0.0324   19.9500
    0.0331   20.6500
    0.0339   21.1300
    0.0347   21.6300
    0.0355   22.1300
    0.0363   22.6500
    0.0372   23.1700
    0.0380   23.7100
    0.0389   24.2700
    0.0398   24.8300
    0.0407   25.4100
    0.0417   26.0000
    0.0427   26.6100
    0.0437   27.2300
    0.0447   27.8600
    0.0457   28.5100
    0.0468   29.1700
    0.0479   29.8500
    0.0490   30.9000
    0.0501   31.2600
    0.0513   31.9900
    0.0525   32.7300
    0.0537   33.5000
    0.0550   34.2800
    0.0562   35.4800
    0.0575   36.3100
    0.0589   37.1500
    0.0603   38.0200
    0.0617   38.9000
    0.0631   39.8100
    0.0646   40.7400
    0.0661   42.1700
    0.0676   43.1500
    0.0692   44.1600
    0.0708   45.1900
    0.0724   46.2400
    0.0741   47.3200
    0.0759   48.4200
    0.0776   50.1200
    0.0794   51.2900
    0.0813   52.4800
    0.0832   53.7000
    0.0851   54.9500
    0.0871   56.2300
    0.0891   58.2100
    0.0912   58.8800
    0.0933   60.2600
    0.0955   62.3700
    0.0977   63.8300
    0.1000   65.3100
    0.1023   66.8300
    0.1047   68.3900
    0.1072   69.9800
    0.1096   70.7900
    0.1122   72.4400
    0.1148   74.1300
    0.1175   75.8600
    0.1202   77.6200
    0.1230   79.4300
    0.1259   81.2800
    0.1288   82.2200
    0.1318   83.1800
    0.1349   85.1100
    0.1380   86.1000
    0.1413   89.1300
    0.1445   90.1600
    0.1479   91.2000
    0.1514   93.3300
    0.1549   95.5000
    0.1585   97.7200
    0.1622   98.8600
    0.1660  100.0000
    0.1698  102.3300
    0.1738  103.5100
    0.1778  105.9300
    0.1820  108.3900
    0.1862  109.6500
    0.1905  112.2000
    0.1950  114.8200
    0.1995  116.1400
    0.2042  117.4900
    0.2089  118.8500
    0.2138  121.6200
    0.2188  123.0300
    0.2239  124.4500
    0.2291  125.8900
    0.2344  127.3500
    0.2399  128.8200
    0.2455  130.3200
    0.2512  131.8300
    0.2570  133.3500
    0.2630  133.3500
    0.2692  134.9000
    0.2754  134.9000
    0.2818  136.4600
    0.2884  136.4600
    0.2951  138.0400
    0.3020  138.0400
    0.3090  139.6400
    0.3162  139.6400];


% ==========
% = Part 4 =
% ==========
V_x = VinVout(:,1);
V_y = VinVout(:,2);
P_x = V_x.^2*50;
P_y = V_y.^2*50;
x = 10*log10(P_x);
y = 10*log10(P_y);
figure(1)
subplot(2,1,1);
plot(x, y);
xlabel('Input Power / dB');
ylabel('Output Power / dB');
title('Amplifier Gain / dB');

% Pick point: x: -13.82, y: 41.79. Power gain: y-x  = 55.61 dB

% ==========
% = Part 5 =
% ==========
format long;
P1 = polyfit(V_x, V_y, 5);
P2 = polyfit(V_x, V_y, 3);

% result: P =
% 
%  1.0e+04 *
% 
% -3.383130356644608   3.462033869677886  -1.464696216469039   0.175515947868351   0.059636354161487  -0.000108994958695


% ==========
% = Part 6 =
% ==========
V_x_new1 = polyval(P1,V_x);
V_x_new2 = polyval(P2,V_x);
% subplot(2,1,2);
plot(V_x, V_y, 'b', V_x, V_x_new1, 'g', V_x, V_x_new2, 'r');
legend('lab data', '5th degree poly', '3rd degree poly');
xlabel('Vin / V');
ylabel('Vout / V');
title('Amplifier Vin vs Vout');

% ==========
% = Part 7 =
% ==========
Fs = 1600*10^6;
N = 2^19;
alpha = 0.024;

b = Fs / N;
f = [115, 121, 124, 132, 135, 140, 151, 160] * 10^6;
f = floor(f./b) * b;


for ii=1:length(f)
	theta(ii) = (2*rand()-1)*pi;
end

v=zeros(1,N);
for ii=1:N
	d = 2 * pi * ii * 1/Fs;
	v(ii) = alpha*(cos(f(1)*d+theta(1)) + cos(f(2)*d+theta(2)) + cos(f(3)*d+theta(3)) + cos(f(4)*d+theta(4)) + cos(f(5)*d+theta(5)) + cos(f(6)*d+theta(6)) + cos(f(7)*d+theta(7)) + cos(f(8)*d+theta(8)));
end


vrms = sqrt((sum((v.^2)./2))/N);
inpower = 10*log10(vrms*vrms*1000/50);

res = polyval(P1,v);

voutrms =  sqrt((sum((res.^2)./2))/N);
outpower = 10*log10(voutrms*voutrms*1000/50);

gain = outpower - inpower;

figure(2);
plot(v, res);

figure(3);

freq= ((-ceil((N-1)/2):N-1-ceil((N-1)/2) )/(N*1/Fs))/10^6;
spectrum = fftshift(abs(fft(res))) ;
spectrumdb = 10*log10(spectrum*1000) - 95.16;
plot(freq,spectrum);
axis([0 800 -60 10]);
xlabel('Freq / MHz');
ylabel('Power / dBm')


specoutpower = 10*log10(spectrum)